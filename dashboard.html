<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Control de Cuentas Netflix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">
  <style>
    .metric-card { transition: transform 0.2s, box-shadow 0.2s; }
    .metric-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .status-vencida { background: rgba(239,68,68,0.2); color: #ef4444; }
    .status-alerta { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .status-normal { background: rgba(6,182,212,0.2); color: #06b6d4; }
    .progress-bar { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.1); overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #06b6d4, #0891b2); transition: width 0.3s; }
    .alert-badge { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .icon-metric { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .table-row:hover { background: rgba(255,255,255,0.03); }
    
    /* Estilos para modal de notificaciones */
    #notification-modal .overflow-y-auto::-webkit-scrollbar { width: 8px; }
    #notification-modal .overflow-y-auto::-webkit-scrollbar-track { background: transparent; border-radius: 10px; }
    #notification-modal .overflow-y-auto::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; transition: background 0.3s ease; }
    #notification-modal .overflow-y-auto::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
    #notification-modal.show { animation: fadeIn 0.2s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .notification-option { cursor: pointer; }
    .notification-option.selected { border-color: #06b6d4 !important; background: rgba(6, 182, 212, 0.1) !important; }
    
    /* Estilos para notificaciones agrupadas */
    .grouped-badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 4px; 
      padding: 2px 8px; 
      background: rgba(139, 92, 246, 0.2); 
      color: #a78bfa; 
      border-radius: 12px; 
      font-size: 10px; 
      font-weight: 600; 
      margin-left: 6px;
    }
    .account-list-item { 
      padding: 8px 12px; 
      background: rgba(0, 0, 0, 0.2); 
      border-radius: 8px; 
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin-bottom: 8px;
    }
    .account-list-item:last-child { margin-bottom: 0; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6">
  <!-- Cargar env.js de forma sÃ­ncrona primero -->
  <script src="env.js"></script>
  <script src="assets/ui.js"></script>
  <script src="assets/auth_guard.js"></script>
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-extrabold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">Dashboard Ejecutivo</h1>
        <p class="text-sm muted mt-1">Usuario: <span id="header-user" class="font-mono px-2 py-1 rounded glass">Cargando...</span></p>
      </div>
      <div class="flex gap-3 items-center flex-wrap">
        <a href="accounts.html" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-all">ğŸ“‹ Cuentas</a>
        <button id="btn-profile" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-all">ğŸ‘¤ Perfil</button>
        <a id="admin-functions-btn" href="admin.html" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-all hidden">âš™ï¸ Admin</a>
        <button id="logout" class="px-4 py-2 rounded-lg border border-red-500/40 text-red-400 hover:bg-red-500/10 transition-all">ğŸšª Salir</button>
      </div>
    </header>
    
    <!-- Theme toggle -->
    <button id="theme-toggle" class="theme-toggle" title="Cambiar tema" aria-label="Cambiar tema"></button>

    <!-- Modal Perfil -->
    <div id="profile-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
      <div class="glass p-6 rounded-2xl max-w-md w-full mx-4">
        <h2 class="text-xl font-semibold mb-4">Perfil</h2>
        <div class="mb-3 text-sm muted">InformaciÃ³n de la cuenta</div>
        <div class="mb-4">
          <label class="block text-xs muted mb-1">Correo</label>
          <div id="profile-email" class="px-3 py-2 bg-black/20 rounded text-sm font-mono">Cargando...</div>
        </div>
        <form id="change-password-form" class="space-y-3">
          <div>
            <label class="block text-xs muted mb-1">Nueva contraseÃ±a</label>
            <input type="password" id="new-password" class="w-full p-3 rounded-lg input-futur" placeholder="Ingrese nueva contraseÃ±a">
          </div>
          <div>
            <label class="block text-xs muted mb-1">Confirmar contraseÃ±a</label>
            <input type="password" id="confirm-password" class="w-full p-3 rounded-lg input-futur" placeholder="Repite la contraseÃ±a">
          </div>
          <div class="flex justify-end gap-3 mt-2">
            <button type="button" onclick="closeProfileModal()" class="px-4 py-2 border border-white/8 rounded">Cerrar</button>
            <button type="submit" class="px-4 py-2 accent-btn rounded">Cambiar contraseÃ±a</button>
          </div>
          <p id="profile-msg" class="text-sm mt-2 hidden"></p>
        </form>
      </div>
    </div>

    <!-- Alertas y Notificaciones -->
    <div id="alerts-section" class="mb-6 space-y-3"></div>

    <!-- KPIs Principales -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="glass metric-card p-5 rounded-2xl">
        <div class="flex items-center justify-between mb-3">
          <div class="icon-metric" style="background: rgba(6,182,212,0.15);">ğŸ“Š</div>
          <div class="text-right">
            <div class="text-sm muted">Total Cuentas</div>
            <div id="metric-total" class="text-3xl font-bold text-cyan-400">0</div>
          </div>
        </div>
        <div class="progress-bar"><div id="progress-total" class="progress-fill" style="width: 100%"></div></div>
      </div>
      
      <div class="glass metric-card p-5 rounded-2xl">
        <div class="flex items-center justify-between mb-3">
          <div class="icon-metric" style="background: rgba(34,197,94,0.15);">ğŸ’°</div>
          <div class="text-right">
            <div class="text-sm muted">Ingresos Totales</div>
            <div id="metric-revenue" class="text-3xl font-bold text-green-400">$0.00</div>
          </div>
        </div>
        <div class="text-xs muted">Promedio: <span id="metric-average-inline" class="text-white font-semibold">$0.00</span>/cuenta</div>
      </div>
      
      <div class="glass metric-card p-5 rounded-2xl">
        <div class="flex items-center justify-between mb-3">
          <div class="icon-metric" style="background: rgba(245,158,11,0.15);">âš ï¸</div>
          <div class="text-right">
            <div class="text-sm muted">Vencen en 7 dÃ­as</div>
            <div id="metric-upcoming" class="text-3xl font-bold text-orange-400">0</div>
          </div>
        </div>
        <div class="text-xs muted">PrÃ³ximos 30d: <span id="metric-upcoming-30d-inline" class="text-white font-semibold">0</span></div>
      </div>
      
      <div class="glass metric-card p-5 rounded-2xl">
        <div class="flex items-center justify-between mb-3">
          <div class="icon-metric" style="background: rgba(239,68,68,0.15);">ğŸ”´</div>
          <div class="text-right">
            <div class="text-sm muted">Vencidas</div>
            <div id="metric-overdue" class="text-3xl font-bold text-red-400">0</div>
          </div>
        </div>
        <div class="text-xs muted">Requieren atenciÃ³n inmediata</div>
      </div>
    </div>

    <!-- MÃ©tricas Secundarias -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="glass p-4 rounded-xl">
        <div class="text-xs muted mb-2">ğŸ“… Ingresos (30 dÃ­as)</div>
        <div id="metric-revenue-30d" class="text-xl font-bold text-cyan-400">$0.00</div>
        <button id="btn-debug-30d" class="text-xs text-cyan-500 hover:text-cyan-400 mt-1">Ver detalle â†’</button>
      </div>
      
      <div class="glass p-4 rounded-xl">
        <div class="text-xs muted mb-2">ğŸ“ˆ Tasa de RenovaciÃ³n</div>
        <div id="metric-renewal-rate" class="text-xl font-bold text-green-400">0%</div>
        <div class="text-xs muted mt-1">Basado en Ãºltimos 30 dÃ­as</div>
      </div>
      
      <div class="glass p-4 rounded-xl">
        <div class="text-xs muted mb-2">ğŸ¯ OcupaciÃ³n</div>
        <div id="metric-occupancy" class="text-xl font-bold text-purple-400">0%</div>
        <div class="text-xs muted mt-1">Cuentas activas vs total</div>
      </div>
      
      <div class="glass p-4 rounded-xl">
        <div class="text-xs muted mb-2">â±ï¸ Promedio de Vida</div>
        <div id="metric-avg-lifetime" class="text-xl font-bold text-blue-400">0 dÃ­as</div>
        <div class="text-xs muted mt-1">Desde fecha de compra</div>
      </div>
    </div>

    <!-- Banner de Notificaciones -->
    <div class="glass p-5 rounded-2xl mb-6 border border-green-500/20">
      <div class="flex items-start gap-4">
        <div class="text-5xl">ğŸ“±</div>
        <div class="flex-1">
          <h3 class="text-lg font-bold text-green-400 mb-2">âœ¨ Sistema de Notificaciones WhatsApp AutomÃ¡tico</h3>
          <p class="text-sm text-white/70 mb-3">
            EnvÃ­a notificaciones automÃ¡ticas a tus clientes con un solo clic usando WAHA API. 
            <span class="text-white font-semibold">Sin abrir pestaÃ±as</span>, <span class="text-green-300 font-semibold">envÃ­o directo e instantÃ¡neo</span>. 
            8 plantillas predefinidas listas para usar.
          </p>
          <div class="flex flex-wrap gap-2 mb-3">
            <span class="px-3 py-1 bg-cyan-500/20 text-cyan-300 rounded-full text-xs">â° Recordatorios de pago</span>
            <span class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-xs">âœ… Confirmaciones</span>
            <span class="px-3 py-1 bg-violet-500/20 text-violet-300 rounded-full text-xs">ğŸ”„ Renovaciones</span>
            <span class="px-3 py-1 bg-white/20 text-white rounded-full text-xs">âœï¸ Personalizados</span>
            <span class="px-3 py-1 bg-orange-500/20 text-orange-300 rounded-full text-xs">ğŸ¤– 100% AutomÃ¡tico</span>
          </div>
          <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-lg p-3">
            <p class="text-sm text-emerald-200">
              <strong>ğŸ’¡ CÃ³mo usar:</strong> En la tabla de "Cuentas que Vencen Pronto" mÃ¡s abajo, 
              haz clic en el botÃ³n <span class="inline-block px-2 py-0.5 bg-green-500/20 text-green-400 rounded text-xs">ğŸ“±</span> 
              de cada cuenta, selecciona el tipo de notificaciÃ³n y da clic en "Enviar NotificaciÃ³n". 
              <strong>El mensaje se enviarÃ¡ automÃ¡ticamente</strong> sin necesidad de abrir WhatsApp Web.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de ConfiguraciÃ³n de AutomatizaciÃ³n -->
    <div id="automation-config-panel" class="glass p-5 rounded-2xl mb-6 border border-cyan-500/20 hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold flex items-center gap-2">
          âš™ï¸ ConfiguraciÃ³n de AutomatizaciÃ³n
        </h2>
        <button onclick="toggleAutomationPanel()" class="text-xs text-cyan-400 hover:text-cyan-300">
          <span id="toggle-panel-text">ğŸ”½ Minimizar</span>
        </button>
      </div>

      <div id="automation-panel-content">
        <!-- Estado del Sistema -->
        <div class="mb-6 p-4 bg-black/20 rounded-xl border border-white/10">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-white/80">ğŸ›ï¸ Estado del Sistema</h3>
            <div id="system-status-badge" class="px-3 py-1 rounded-full text-xs font-semibold">
              <span id="status-indicator">â—</span> <span id="status-text">Cargando...</span>
            </div>
          </div>
          
          <div class="flex gap-2 flex-wrap">
            <button onclick="pauseAutomation()" id="btn-pause" class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-300 rounded-lg text-sm transition disabled:opacity-50">
              â¸ï¸ Pausar
            </button>
            <button onclick="resumeAutomation()" id="btn-resume" class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 rounded-lg text-sm transition disabled:opacity-50">
              â–¶ï¸ Reanudar
            </button>
            <button onclick="setMaintenanceMode()" id="btn-maintenance" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 rounded-lg text-sm transition disabled:opacity-50">
              ğŸ”§ Mantenimiento
            </button>
            <button onclick="loadAutomationConfig()" class="px-4 py-2 glass hover:bg-white/10 text-cyan-300 rounded-lg text-sm transition">
              ğŸ”„ Recargar
            </button>
          </div>

          <div id="pause-reason-input" class="mt-3 hidden">
            <input type="text" id="pause-reason" placeholder="RazÃ³n de la pausa (opcional)" class="w-full px-3 py-2 rounded-lg input-futur text-sm">
          </div>
        </div>

        <!-- ConfiguraciÃ³n de Intervalos -->
        <div class="mb-6 p-4 bg-black/20 rounded-xl border border-white/10">
          <h3 class="text-sm font-semibold text-white/80 mb-4">â±ï¸ Intervalos de EnvÃ­o (milisegundos)</h3>
          
          <div class="space-y-4">
            <div>
              <div class="flex justify-between mb-2">
                <label class="text-xs text-white/60">EnvÃ­o Masivo:</label>
                <span id="interval-bulk-value" class="text-xs text-cyan-300 font-mono">3000ms</span>
              </div>
              <input type="range" id="interval-bulk" min="1000" max="10000" step="500" value="3000" 
                class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                oninput="updateIntervalDisplay('bulk', this.value)">
              <div class="flex justify-between text-xs text-white/40 mt-1">
                <span>1s</span>
                <span>10s</span>
              </div>
            </div>

            <div>
              <div class="flex justify-between mb-2">
                <label class="text-xs text-white/60">Reintentos:</label>
                <span id="interval-retry-value" class="text-xs text-cyan-300 font-mono">5000ms</span>
              </div>
              <input type="range" id="interval-retry" min="2000" max="15000" step="1000" value="5000" 
                class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                oninput="updateIntervalDisplay('retry', this.value)">
              <div class="flex justify-between text-xs text-white/40 mt-1">
                <span>2s</span>
                <span>15s</span>
              </div>
            </div>

            <div>
              <div class="flex justify-between mb-2">
                <label class="text-xs text-white/60">VerificaciÃ³n de Estado:</label>
                <span id="interval-check-value" class="text-xs text-cyan-300 font-mono">60000ms</span>
              </div>
              <input type="range" id="interval-check" min="30000" max="300000" step="30000" value="60000" 
                class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                oninput="updateIntervalDisplay('check', this.value)">
              <div class="flex justify-between text-xs text-white/40 mt-1">
                <span>30s</span>
                <span>5min</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Tipos de Notificaciones -->
        <div class="mb-6 p-4 bg-black/20 rounded-xl border border-white/10">
          <h3 class="text-sm font-semibold text-white/80 mb-4">ğŸ“¬ Tipos de Notificaciones Activas</h3>
          
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border border-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="notif-3-days" checked class="w-4 h-4 accent-cyan-500">
                <label for="notif-3-days" class="text-sm cursor-pointer">â° 3 dÃ­as antes</label>
              </div>
              <input type="number" id="interval-3-days" min="1000" max="10000" step="500" value="2000" 
                class="w-20 px-2 py-1 rounded input-futur text-xs text-center">
            </div>

            <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border border-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="notif-2-days" checked class="w-4 h-4 accent-cyan-500">
                <label for="notif-2-days" class="text-sm cursor-pointer">âš ï¸ 2 dÃ­as antes</label>
              </div>
              <input type="number" id="interval-2-days" min="1000" max="10000" step="500" value="2000" 
                class="w-20 px-2 py-1 rounded input-futur text-xs text-center">
            </div>

            <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border border-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="notif-1-day" checked class="w-4 h-4 accent-cyan-500">
                <label for="notif-1-day" class="text-sm cursor-pointer">ğŸ”´ 1 dÃ­a antes</label>
              </div>
              <input type="number" id="interval-1-day" min="1000" max="10000" step="500" value="2000" 
                class="w-20 px-2 py-1 rounded input-futur text-xs text-center">
            </div>

            <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border border-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="notif-due-today" checked class="w-4 h-4 accent-cyan-500">
                <label for="notif-due-today" class="text-sm cursor-pointer">ğŸ’¸ Vence HOY (Prioridad)</label>
              </div>
              <input type="number" id="interval-due-today" min="500" max="10000" step="500" value="1000" 
                class="w-20 px-2 py-1 rounded input-futur text-xs text-center">
            </div>

            <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border border-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="notif-overdue" checked class="w-4 h-4 accent-cyan-500">
                <label for="notif-overdue" class="text-sm cursor-pointer">ğŸ”¥ ATRASADO (Urgente)</label>
              </div>
              <input type="number" id="interval-overdue" min="500" max="10000" step="500" value="1000" 
                class="w-20 px-2 py-1 rounded input-futur text-xs text-center">
            </div>

            <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border border-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="notif-renewal" checked class="w-4 h-4 accent-cyan-500">
                <label for="notif-renewal" class="text-sm cursor-pointer">ğŸ”„ RenovaciÃ³n prÃ³xima</label>
              </div>
              <input type="number" id="interval-renewal" min="1000" max="10000" step="500" value="3000" 
                class="w-20 px-2 py-1 rounded input-futur text-xs text-center">
            </div>
          </div>
        </div>

        <!-- LÃ­mites de Seguridad -->
        <div class="mb-6 p-4 bg-black/20 rounded-xl border border-white/10">
          <h3 class="text-sm font-semibold text-white/80 mb-4">ğŸ›¡ï¸ LÃ­mites de Seguridad</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs text-white/60 mb-2">Max. mensajes por hora:</label>
              <input type="number" id="limit-per-hour" min="10" max="200" value="50" 
                class="w-full px-3 py-2 rounded-lg input-futur text-sm">
            </div>
            
            <div>
              <label class="block text-xs text-white/60 mb-2">Max. reintentos:</label>
              <input type="number" id="limit-retries" min="1" max="10" value="3" 
                class="w-full px-3 py-2 rounded-lg input-futur text-sm">
            </div>
            
            <div>
              <label class="block text-xs text-white/60 mb-2">Cooldown tras error (min):</label>
              <input type="number" id="limit-cooldown" min="5" max="120" value="30" 
                class="w-full px-3 py-2 rounded-lg input-futur text-sm">
            </div>
          </div>
        </div>

        <!-- EstadÃ­sticas del DÃ­a -->
        <div class="mb-6 p-4 bg-black/20 rounded-xl border border-white/10">
          <h3 class="text-sm font-semibold text-white/80 mb-4">ğŸ“Š EstadÃ­sticas de Hoy</h3>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-400" id="stat-sent-today">0</div>
              <div class="text-xs text-white/60 mt-1">Enviados</div>
            </div>
            
            <div class="text-center">
              <div class="text-2xl font-bold text-red-400" id="stat-failed-today">0</div>
              <div class="text-xs text-white/60 mt-1">Fallidos</div>
            </div>
            
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-400" id="stat-pending-today">0</div>
              <div class="text-xs text-white/60 mt-1">Pendientes</div>
            </div>
            
            <div class="text-center">
              <div class="text-2xl font-bold text-cyan-400" id="stat-rate-limit">50</div>
              <div class="text-xs text-white/60 mt-1">LÃ­mite/hora</div>
            </div>
          </div>
        </div>

        <!-- BotÃ³n Guardar -->
        <div class="flex justify-end gap-3">
          <button onclick="resetAutomationConfig()" class="px-4 py-2 border border-white/20 hover:bg-white/10 rounded-lg text-sm transition">
            â†º Restaurar Valores
          </button>
          <button onclick="saveAutomationConfig()" class="px-6 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold rounded-lg text-sm transition">
            ğŸ’¾ Guardar ConfiguraciÃ³n
          </button>
        </div>
      </div>
    </div>

    <!-- Top Propietarios -->
    <div class="glass p-5 rounded-2xl mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">ğŸ† Top 5 Propietarios</h2>
        <span class="text-xs muted">Por nÃºmero de cuentas</span>
      </div>
      <div id="metric-topowners-container" class="space-y-2">
        <div class="text-sm muted">Cargando...</div>
      </div>
    </div>

    <!-- GrÃ¡ficos Principales -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="glass p-5 rounded-2xl">
        <h3 class="text-sm font-bold mb-4 muted">ğŸ“Š Cuentas Nuevas (Ãšltimos 6 Meses)</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="chart-monthly"></canvas>
        </div>
      </div>
      <div class="glass p-5 rounded-2xl">
        <h3 class="text-sm font-bold mb-4 muted">ğŸ¯ Estado de Cuentas</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="chart-status"></canvas>
        </div>
      </div>
      <div class="glass p-5 rounded-2xl">
        <h3 class="text-sm font-bold mb-4 muted">ğŸ¬ DistribuciÃ³n por Servicio</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="chart-services"></canvas>
        </div>
      </div>
    </div>

    <!-- GrÃ¡ficos Secundarios -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="glass p-5 rounded-2xl">
        <h3 class="text-sm font-bold mb-4 muted">ğŸ’µ DistribuciÃ³n de Precios</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="chart-prices"></canvas>
        </div>
      </div>
      <div class="glass p-5 rounded-2xl">
        <h3 class="text-sm font-bold mb-4 muted">ğŸ“ˆ Tendencia de Ingresos (6 Meses)</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="chart-revenue-trend"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla de Cuentas PrÃ³ximas a Vencer -->
    <div class="glass p-5 rounded-2xl mb-6 border border-orange-500/20">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-3">
        <div>
          <h2 class="text-lg font-bold flex items-center gap-2">
            â° Cuentas que Vencen Pronto
            <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full">ğŸ“± Con Notificaciones</span>
          </h2>
          <p class="text-xs text-white/60 mt-1">Haz clic en ğŸ“± para enviar notificaciones automÃ¡ticas por WhatsApp</p>
        </div>
        <div class="flex gap-2">
          <button id="filter-7d" class="px-3 py-1 rounded-lg text-xs bg-orange-500/20 text-orange-400 hover:bg-orange-500/30">7 dÃ­as</button>
          <button id="filter-30d" class="px-3 py-1 rounded-lg text-xs glass hover:bg-white/10">30 dÃ­as</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-xs muted border-b border-white/10">
            <tr>
              <th class="text-left py-3 px-2">Estado</th>
              <th class="text-left py-3 px-2">Propietario</th>
              <th class="text-left py-3 px-2">Correo</th>
              <th class="text-left py-3 px-2">Precio</th>
              <th class="text-left py-3 px-2">Vencimiento</th>
              <th class="text-left py-3 px-2">DÃ­as Restantes</th>
              <th class="text-center py-3 px-2">
                <span class="flex items-center justify-center gap-1">
                  AcciÃ³n 
                  <span class="text-green-400">ğŸ“±</span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody id="upcoming-accounts-tbody" class="text-sm"></tbody>
        </table>
      </div>
      <div id="upcoming-empty" class="text-center py-8 text-sm muted hidden">
        âœ… No hay cuentas prÃ³ximas a vencer
      </div>
    </div>

    <!-- Modal de Notificaciones WhatsApp -->
    <div id="notification-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4">
      <div class="glass rounded-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex items-center justify-between p-6 pb-4 border-b border-white/10 flex-shrink-0">
          <h2 class="text-xl font-semibold">ğŸ“± Enviar NotificaciÃ³n WhatsApp</h2>
          <button onclick="closeNotificationModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
        </div>
        
        <div class="overflow-y-auto flex-1 p-6 pt-4" style="scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;">
        
        <div class="mb-4 p-4 bg-black/20 rounded-lg">
          <div class="text-xs text-white/60 mb-1">Cliente</div>
          <div id="notify-propietario" class="font-semibold text-lg">-</div>
          <div class="text-xs text-white/60 mt-2">TelÃ©fono</div>
          <div id="notify-telefono" class="font-mono text-sm">-</div>
        </div>

        <div class="mb-4">
          <label class="block text-sm muted mb-2">Selecciona el tipo de notificaciÃ³n:</label>
          <div class="space-y-2">
            <button onclick="selectNotificationType('pago_3dias', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-cyan-500/50">
              <div class="font-semibold text-cyan-300 text-sm">â° Recordatorio - 3 dÃ­as para pago</div>
            </button>
            
            <button onclick="selectNotificationType('pago_2dias', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-cyan-500/50">
              <div class="font-semibold text-amber-300 text-sm">âš ï¸ Recordatorio - 2 dÃ­as para pago</div>
            </button>
            
            <button onclick="selectNotificationType('pago_1dia', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-cyan-500/50">
              <div class="font-semibold text-orange-300 text-sm">ğŸš¨ Recordatorio - 1 dÃ­a para pago</div>
            </button>
            
            <button onclick="selectNotificationType('pago_hoy', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-rose-500/50">
              <div class="font-semibold text-rose-300 text-sm">ğŸ”´ Pago vence HOY</div>
            </button>
            
            <button onclick="selectNotificationType('pago_atrasado', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-rose-500/50">
              <div class="font-semibold text-rose-400 text-sm">ğŸ’¸ Pago atrasado</div>
            </button>
            
            <button onclick="selectNotificationType('confirmacion_pago', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-emerald-500/50">
              <div class="font-semibold text-emerald-300 text-sm">âœ… ConfirmaciÃ³n de pago</div>
            </button>
            
            <button onclick="selectNotificationType('renovacion_proxima', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-violet-500/50">
              <div class="font-semibold text-violet-300 text-sm">ğŸ”„ RenovaciÃ³n prÃ³xima</div>
            </button>
            
            <button onclick="selectNotificationType('personalizado', this)" class="notification-option w-full text-left p-3 bg-black/20 hover:bg-black/30 rounded-lg transition border border-white/10 hover:border-white/20">
              <div class="font-semibold text-white/90 text-sm">âœï¸ Mensaje personalizado</div>
            </button>
          </div>
        </div>

        <div id="message-preview-container" class="mb-4 hidden">
          <label class="block text-sm muted mb-2">Vista previa del mensaje:</label>
          <div class="p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-lg">
            <pre id="message-preview" class="text-sm whitespace-pre-wrap">-</pre>
          </div>
          <div id="custom-message-container" class="mt-3 hidden">
            <textarea id="custom-message-input" rows="5" class="w-full p-3 rounded-lg input-futur" placeholder="Escribe tu mensaje personalizado..."></textarea>
          </div>
        </div>

        <div id="notification-warning" class="mb-4 p-3 bg-amber-900/20 border border-amber-500/30 rounded-lg text-sm text-amber-200 hidden">
          <strong>âš ï¸ Advertencia:</strong> <span id="warning-text"></span>
        </div>

        </div>

        <div class="flex gap-3 p-6 pt-4 border-t border-white/10 flex-shrink-0">
          <button onclick="closeNotificationModal()" class="flex-1 px-4 py-3 border border-white/10 rounded-lg hover:bg-white/5 transition">
            Cancelar
          </button>
          <button id="send-whatsapp-btn" onclick="sendWhatsAppMessage()" class="flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            âœ… Enviar NotificaciÃ³n
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de SelecciÃ³n de NotificaciÃ³n (Individual o Grupal) -->
    <div id="notification-choice-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4">
      <div class="glass rounded-2xl max-w-lg w-full p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">ğŸ“± Opciones de NotificaciÃ³n</h2>
          <button onclick="closeNotificationChoiceModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
        </div>

        <div class="mb-4 p-4 bg-black/20 rounded-lg">
          <div class="text-xs text-white/60 mb-1">Cliente</div>
          <div id="choice-propietario" class="font-semibold text-lg">-</div>
          <div class="text-xs text-white/60 mt-2">TelÃ©fono</div>
          <div id="choice-telefono" class="font-mono text-sm">-</div>
        </div>

        <div id="grouped-accounts-info" class="mb-4 hidden">
          <div class="text-sm muted mb-2">Cuentas encontradas que caducan el mismo dÃ­a:</div>
          <div id="grouped-accounts-list" class="space-y-2">
            <!-- Se llenarÃ¡ dinÃ¡micamente -->
          </div>
        </div>

        <div class="space-y-3">
          <button id="btn-notify-single" onclick="proceedWithSingleNotification()" class="w-full text-left p-4 bg-gradient-to-r from-cyan-600/20 to-blue-600/20 hover:from-cyan-600/30 hover:to-blue-600/30 rounded-lg transition border border-cyan-500/30 hover:border-cyan-500/50">
            <div class="flex items-center gap-3">
              <div class="text-3xl">ğŸ“„</div>
              <div class="flex-1">
                <div class="font-semibold text-cyan-300">NotificaciÃ³n Individual</div>
                <div class="text-xs text-white/60 mt-1">Enviar mensaje solo para esta cuenta</div>
              </div>
            </div>
          </button>

          <button id="btn-notify-grouped" onclick="proceedWithGroupedNotification()" class="w-full text-left p-4 bg-gradient-to-r from-violet-600/20 to-purple-600/20 hover:from-violet-600/30 hover:to-purple-600/30 rounded-lg transition border border-violet-500/30 hover:border-violet-500/50 hidden">
            <div class="flex items-center gap-3">
              <div class="text-3xl">ğŸ“¦</div>
              <div class="flex-1">
                <div class="font-semibold text-violet-300">NotificaciÃ³n Agrupada</div>
                <div class="text-xs text-white/60 mt-1">
                  Enviar un solo mensaje con todas las cuentas (<span id="grouped-count">0</span> cuentas)
                </div>
              </div>
            </div>
          </button>
        </div>

        <div class="mt-4 flex justify-end">
          <button onclick="closeNotificationChoiceModal()" class="px-4 py-2 border border-white/10 rounded-lg hover:bg-white/5 transition">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-sm muted flex flex-col md:flex-row justify-between items-center gap-3 pb-6">
      <div class="flex gap-4">
        <a href="accounts.html" class="hover:text-white transition-colors">Ver todas las cuentas â†’</a>
      </div>
      <span class="text-xs text-white/40">Dashboard v2.0 â€¢ Actualizado: <span id="last-update">--:--</span></span>
    </div>
  </div>

  <script>
    // Soporte Supabase + fallback local para Dashboard
    let useSupabase = !!(window.SUPABASE_URL && window.SUPABASE_ANON_KEY);
    async function ensureSupabase(){ 
      if(!useSupabase) return null; 
      if(window.__supabase) return window.__supabase; 
      
      if(typeof supabase === 'undefined'){ 
        await new Promise((res,rej)=>{ 
          const s=document.createElement('script'); 
          s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'; 
          s.onload=res; 
          s.onerror=rej; 
          document.head.appendChild(s); 
        }).catch((err)=>{ console.error('Error cargando Supabase:', err); }); 
      } 
      
      await new Promise(resolve => setTimeout(resolve, 100));
      
      if(typeof supabase !== 'undefined' && supabase.createClient){ 
        window.__supabase = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY); 
        return window.__supabase; 
      } else if(typeof window.createClient !== 'undefined'){ 
        window.__supabase = window.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY); 
        return window.__supabase; 
      } 
      return null; 
    }

    let currentUserId = localStorage.getItem('current_user_id');
    let allAccounts = [];
    let chartMonthly=null, chartStatus=null, chartPrices=null, chartRevenueTrend=null, chartServices=null;
    let upcomingFilterDays = 7; // filtro por defecto

    async function init(){
      try{ if(window.__auth){ const ok = await window.__auth.requireAuth(); if(!ok) return; } }catch(e){}
      
      // Primero verificar si hay sesiÃ³n con cÃ³digo de acceso
      const accessCodeSession = localStorage.getItem('access_code_session');
      if(accessCodeSession){
        try{
          const sessionData = JSON.parse(accessCodeSession);
          // Verificar que el cÃ³digo no haya expirado
          if(sessionData.expires_at && new Date(sessionData.expires_at) > new Date()){
            // Usuario con cÃ³digo de acceso vÃ¡lido
            currentUserId = sessionData.user_id;
            localStorage.setItem('current_user_id', currentUserId);
            
            const headerEl = document.getElementById('header-user');
            if(headerEl) headerEl.textContent = sessionData.email || sessionData.user_id;
            
            // Configurar logout para cÃ³digo de acceso
            document.getElementById('logout').addEventListener('click', async ()=>{ 
              localStorage.removeItem('access_code_session');
              localStorage.removeItem('current_user_id');
              window.location.href='login.html'; 
            });
            
            document.getElementById('btn-profile').addEventListener('click', ()=> openProfileModal());
            document.getElementById('filter-7d').addEventListener('click', ()=> { upcomingFilterDays = 7; renderUpcomingAccounts(); updateFilterButtons(); });
            document.getElementById('filter-30d').addEventListener('click', ()=> { upcomingFilterDays = 30; renderUpcomingAccounts(); updateFilterButtons(); });
            
            console.log('âœ… Dashboard cargado con sesiÃ³n de cÃ³digo de acceso');
            return; // SesiÃ³n vÃ¡lida, continuar con el dashboard
          } else {
            // CÃ³digo expirado
            console.warn('CÃ³digo de acceso expirado');
            localStorage.removeItem('access_code_session');
            localStorage.removeItem('current_user_id');
            window.location.href = 'login.html';
            return;
          }
        }catch(e){ 
          console.error('Error parsing access_code_session', e);
          localStorage.removeItem('access_code_session');
        }
      }
      
      // Si no hay sesiÃ³n con cÃ³digo, verificar sesiÃ³n Supabase (admin)
      if(useSupabase){ 
        const client = await ensureSupabase(); 
        if(!client){ 
          useSupabase=false; 
        } else { 
          try{ 
            const { data } = await client.auth.getUser(); 
            const user = data?.user || null; 
            if(user && user.id){ 
              currentUserId = user.id; 
              localStorage.setItem('current_user_id', currentUserId); 
              const headerEl = document.getElementById('header-user'); 
              if(headerEl) headerEl.textContent = user.email || currentUserId; 
            } else { 
              window.location.href='login.html'; 
            } 
          }catch(e){ 
            console.error(e); 
            window.location.href='login.html'; 
          }
        }
      } else { 
        if(!currentUserId) window.location.href='login.html'; 
      }
      
      // Verificar si es admin
      try{
        if(useSupabase && window.__supabase){
          const { data: isAdminData, error: isAdminError } = await window.__supabase.rpc('is_admin');
          const isAdmin = (!isAdminError && (isAdminData === true || (Array.isArray(isAdminData) && isAdminData.length && (isAdminData[0] === true || isAdminData[0] === 1)) || (isAdminData && isAdminData.is_admin)));
          if(isAdmin){ 
            const btn = document.getElementById('admin-functions-btn'); 
            if(btn) btn.classList.remove('hidden'); 
          }
        }
      }catch(e){ /* ignore */ }
      
      if(!useSupabase){ 
        try{ 
          const users = JSON.parse(localStorage.getItem('netflix_users')||'[]'); 
          const u = users.find(x=>x.id===currentUserId); 
          const headerEl = document.getElementById('header-user'); 
          if(headerEl) headerEl.textContent = u?.email || currentUserId; 
        }catch(e){ console.error(e); } 
      }
      
      document.getElementById('logout').addEventListener('click', async ()=>{ 
        if(useSupabase && window.__supabase) await window.__supabase.auth.signOut(); 
        localStorage.removeItem('current_user_id'); 
        window.location.href='index.html'; 
      });
      
      document.getElementById('btn-profile').addEventListener('click', ()=> openProfileModal());
      document.getElementById('filter-7d').addEventListener('click', ()=> { upcomingFilterDays = 7; renderUpcomingAccounts(); updateFilterButtons(); });
      document.getElementById('filter-30d').addEventListener('click', ()=> { upcomingFilterDays = 30; renderUpcomingAccounts(); updateFilterButtons(); });
    }

    function updateFilterButtons(){
      document.getElementById('filter-7d').className = upcomingFilterDays === 7 ? 'px-3 py-1 rounded-lg text-xs bg-orange-500/20 text-orange-400' : 'px-3 py-1 rounded-lg text-xs glass hover:bg-white/10';
      document.getElementById('filter-30d').className = upcomingFilterDays === 30 ? 'px-3 py-1 rounded-lg text-xs bg-orange-500/20 text-orange-400' : 'px-3 py-1 rounded-lg text-xs glass hover:bg-white/10';
    }

    function getLocalAccounts(){ 
      const data = localStorage.getItem(`netflix_accounts_local-netflix-app_${currentUserId}`); 
      return data? JSON.parse(data): []; 
    }

    function calculateDaysRemaining(expiryDateString){ 
      if(!expiryDateString) return {days:null}; 
      const expiry = new Date(expiryDateString+'T00:00:00'); 
      const today = new Date(); 
      expiry.setHours(0,0,0,0); 
      today.setHours(0,0,0,0); 
      const diff = Math.ceil((expiry.getTime()-today.getTime())/(1000*60*60*24)); 
      return {days:diff}; 
    }

    async function fetchAccounts(){ 
      if(useSupabase && window.__supabase){ 
        try{ 
          const { data, error } = await window.__supabase.from('netflix_accounts').select('*').eq('user_id', currentUserId); 
          if(error) throw error; 
          return (data||[]).map(r=>({ 
            id:r.id, 
            propietario:r.propietario, 
            correo:r.correo, 
            fechaCompra:r.fecha_compra, 
            fechaPago:r.fecha_pago, 
            fechaCaducidad:r.fecha_caducidad, 
            precio:r.precio,
            servicio:r.servicio
          })); 
        }catch(err){ 
          console.error(err); 
          return getLocalAccounts(); 
        } 
      } else { 
        return getLocalAccounts(); 
      } 
    }

    function parseDateAny(s){ 
      if(!s) return null; 
      try{
        if(s instanceof Date) { 
          const d = new Date(s.getFullYear(), s.getMonth(), s.getDate()); 
          return d; 
        }
        let d = new Date(s);
        if(!isNaN(d.getTime())) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const ymd = /^\s*(\d{4})-(\d{1,2})-(\d{1,2})\s*$/;
        let m = s.match(ymd);
        if(m){ return new Date(Number(m[1]), Number(m[2])-1, Number(m[3])); }
        const dmy = /^\s*(\d{1,2})\/(\d{1,2})\/(\d{4})\s*$/;
        m = s.match(dmy);
        if(m){ return new Date(Number(m[3]), Number(m[2])-1, Number(m[1])); }
      }catch(e){}
      return null; 
    }

    async function update(){ 
      allAccounts = await fetchAccounts(); 
      const now = new Date(); 
      now.setHours(0,0,0,0);
      
      // MÃ©tricas bÃ¡sicas
      document.getElementById('metric-total').textContent = allAccounts.length;
      const revenue = allAccounts.reduce((s,a)=> s + (parseFloat(a.precio)||0),0); 
      document.getElementById('metric-revenue').textContent = `$${revenue.toFixed(2)}`;
      
      // AnÃ¡lisis de estados
      const statusCounts = {vencida:0, alerta:0, normal:0};
      let revenue30 = 0; 
      let upcoming7 = 0;
      let upcoming30 = 0;
      let totalLifetimeDays = 0;
      let accountsWithLifetime = 0;
      
      allAccounts.forEach(a=>{ 
        const days = calculateDaysRemaining(a.fechaCaducidad).days; 
        
        // Estados
        if(days!==null && days<0) statusCounts.vencida++; 
        else if(days!==null && days<=7) statusCounts.alerta++; 
        else statusCounts.normal++;
        
        // Vencimientos
        if(days!==null && days>=0 && days<=7) upcoming7++;
        if(days!==null && days>=0 && days<=30) upcoming30++; 
        
        // Revenue Ãºltimos 30 dÃ­as
        const pagoDate = parseDateAny(a.fechaPago);
        const compraDate = parseDateAny(a.fechaCompra);
        const diffPago = pagoDate ? Math.floor((now.getTime() - pagoDate.getTime())/(1000*60*60*24)) : null;
        const diffCompra = compraDate ? Math.floor((now.getTime() - compraDate.getTime())/(1000*60*60*24)) : null;
        const includedPago = diffPago!==null && diffPago>=0 && diffPago<=30;
        const includedCompra = diffCompra!==null && diffCompra>=0 && diffCompra<=30;
        const included = includedPago || includedCompra;
        if(included) revenue30 += (parseFloat(a.precio)||0);
        
        // Lifetime promedio
        if(compraDate){
          const lifetime = Math.floor((now.getTime() - compraDate.getTime())/(1000*60*60*24));
          totalLifetimeDays += lifetime;
          accountsWithLifetime++;
        }
        
        a.__debug_revenue = { 
          pagoRaw: a.fechaPago||null, pagoDate, diffPago, 
          compraRaw: a.fechaCompra||null, compraDate, diffCompra, 
          included, matched: includedPago? 'fechaPago': (includedCompra? 'fechaCompra': null) 
        };
      });
      
      // Actualizar mÃ©tricas principales
      document.getElementById('metric-upcoming').textContent = upcoming7;
      document.getElementById('metric-overdue').textContent = statusCounts.vencida;
      
      const avg = allAccounts.length? (revenue / allAccounts.length) : 0; 
      document.getElementById('metric-average-inline').textContent = `$${avg.toFixed(2)}`;
      document.getElementById('metric-revenue-30d').textContent = `$${revenue30.toFixed(2)}`;
      document.getElementById('metric-upcoming-30d-inline').textContent = upcoming30;
      
      // MÃ©tricas adicionales
      const renewalRate = upcoming30 > 0 ? ((upcoming30 - statusCounts.vencida) / upcoming30 * 100).toFixed(1) : 0;
      document.getElementById('metric-renewal-rate').textContent = `${renewalRate}%`;
      
      const occupancy = allAccounts.length > 0 ? ((statusCounts.normal + statusCounts.alerta) / allAccounts.length * 100).toFixed(1) : 0;
      document.getElementById('metric-occupancy').textContent = `${occupancy}%`;
      
      const avgLifetime = accountsWithLifetime > 0 ? Math.round(totalLifetimeDays / accountsWithLifetime) : 0;
      document.getElementById('metric-avg-lifetime').textContent = `${avgLifetime} dÃ­as`;
      
      // Top Propietarios
      const ownerCounts = {};
      allAccounts.forEach(a=>{ 
        const owner = a.propietario || 'Sin propietario'; 
        ownerCounts[owner] = (ownerCounts[owner]||0) + 1; 
      });
      const topOwners = Object.keys(ownerCounts).map(k=>({ 
        propietario:k, count: ownerCounts[k] 
      })).sort((a,b)=> b.count - a.count).slice(0,5);
      
      const topContainer = document.getElementById('metric-topowners-container'); 
      if(topContainer){ 
        topContainer.innerHTML = ''; 
        if(topOwners.length===0){ 
          topContainer.innerHTML = '<div class="text-sm muted">Sin datos</div>'; 
        } else { 
          topOwners.forEach((t, idx)=>{ 
            const maxCount = topOwners[0].count;
            const percentage = maxCount > 0 ? (t.count / maxCount * 100) : 0;
            const div = document.createElement('div'); 
            div.className='flex items-center justify-between py-2 px-3 glass rounded-lg hover:bg-white/5 transition-all'; 
            div.innerHTML = `
              <div class="flex items-center gap-3 flex-1">
                <span class="text-xl">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸'][idx] || 'ğŸ…'}</span>
                <div class="flex-1">
                  <div class="font-semibold text-sm">${t.propietario}</div>
                  <div class="progress-bar mt-1" style="height: 4px;">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-cyan-400">${t.count}</div>
                <div class="text-xs muted">cuentas</div>
              </div>
            `; 
            topContainer.appendChild(div); 
          }); 
        } 
      }
      
      // Alertas
      renderAlerts(statusCounts, upcoming7);
      
      // Guardar detalles para depuraciÃ³n
      window.__revenue30_details = allAccounts.map(a=>{
        const d = a.__debug_revenue || {};
        return { 
          id:a.id, propietario:a.propietario, precio:a.precio, 
          fechaPagoRaw: d.pagoRaw || null, 
          fechaPagoParsed: d.pagoDate? d.pagoDate.toLocaleDateString() : null, 
          diffPago: d.diffPago===null? null: d.diffPago, 
          fechaCompraRaw: d.compraRaw || null, 
          fechaCompraParsed: d.compraDate? d.compraDate.toLocaleDateString() : null, 
          diffCompra: d.diffCompra===null? null: d.diffCompra, 
          included: d.included? 'sÃ­':'no', 
          matched: d.matched || null 
        };
      });
      
      // Renderizar grÃ¡ficos y tabla
      renderCharts(now, statusCounts);
      renderUpcomingAccounts();
      
      // Actualizar timestamp
      const now2 = new Date();
      document.getElementById('last-update').textContent = `${now2.getHours()}:${String(now2.getMinutes()).padStart(2,'0')}`;
    }

    function renderAlerts(statusCounts, upcoming7){
      const alertsSection = document.getElementById('alerts-section');
      alertsSection.innerHTML = '';
      
      if(statusCounts.vencida > 0){
        const alert = document.createElement('div');
        alert.className = 'glass p-4 rounded-xl border-l-4 border-red-500 alert-badge';
        alert.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ”´</span>
            <div class="flex-1">
              <div class="font-bold text-red-400">Â¡AtenciÃ³n! Cuentas Vencidas</div>
              <div class="text-sm muted">Tienes ${statusCounts.vencida} cuenta${statusCounts.vencida > 1 ? 's' : ''} vencida${statusCounts.vencida > 1 ? 's' : ''} que requiere${statusCounts.vencida > 1 ? 'n' : ''} renovaciÃ³n inmediata</div>
            </div>
            <a href="accounts.html" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all">Ver detalles</a>
          </div>
        `;
        alertsSection.appendChild(alert);
      }
      
      if(upcoming7 > 0){
        const alert = document.createElement('div');
        alert.className = 'glass p-4 rounded-xl border-l-4 border-orange-500';
        alert.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">âš ï¸</span>
            <div class="flex-1">
              <div class="font-bold text-orange-400">Renovaciones PrÃ³ximas</div>
              <div class="text-sm muted">${upcoming7} cuenta${upcoming7 > 1 ? 's' : ''} vence${upcoming7 > 1 ? 'n' : ''} en los prÃ³ximos 7 dÃ­as</div>
            </div>
          </div>
        `;
        alertsSection.appendChild(alert);
      }
      
      if(statusCounts.vencida === 0 && upcoming7 === 0){
        const alert = document.createElement('div');
        alert.className = 'glass p-4 rounded-xl border-l-4 border-green-500';
        alert.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">âœ…</span>
            <div class="flex-1">
              <div class="font-bold text-green-400">Todo en Orden</div>
              <div class="text-sm muted">No hay cuentas vencidas ni prÃ³ximas a vencer</div>
            </div>
          </div>
        `;
        alertsSection.appendChild(alert);
      }
    }

    function renderCharts(now, statusCounts){
      // GrÃ¡fico mensual
      const months = []; 
      for(let i=5;i>=0;i--){ 
        const d = new Date(now.getFullYear(), now.getMonth()-i,1); 
        months.push(`${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`); 
      }
      const monthlyCounts = months.map(m=> allAccounts.filter(a=> a.fechaCompra && (a.fechaCompra.substring(5,7)+'/'+a.fechaCompra.substring(0,4))===m).length);

      const ctx = document.getElementById('chart-monthly').getContext('2d'); 
      if(chartMonthly){ 
        chartMonthly.data.labels=months; 
        chartMonthly.data.datasets[0].data=monthlyCounts; 
        chartMonthly.update('active'); 
      } else { 
        chartMonthly = new Chart(ctx, {
          type:'bar', 
          data:{
            labels:months, 
            datasets:[{
              label:'Cuentas Nuevas', 
              data:monthlyCounts, 
              backgroundColor:'rgba(6,182,212,0.7)',
              borderColor:'#06b6d4',
              borderWidth:2,
              borderRadius: 8,
              hoverBackgroundColor:'rgba(6,182,212,0.9)'
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:{
              duration: 1000,
              easing: 'easeInOutQuart',
              delay: (context) => {
                let delay = 0;
                if (context.type === 'data' && context.mode === 'default') {
                  delay = context.dataIndex * 100;
                }
                return delay;
              }
            },
            plugins:{
              legend:{display:false},
              tooltip:{
                backgroundColor:'rgba(0,0,0,0.8)',
                padding:12,
                cornerRadius:8,
                titleColor:'#06b6d4',
                bodyColor:'#fff'
              }
            },
            plugins:{
              legend:{display:false},
              tooltip:{
                backgroundColor:'rgba(0,0,0,0.8)',
                padding:12,
                cornerRadius:8,
                titleColor:'#06b6d4',
                bodyColor:'#fff'
              }
            },
            scales:{
              y:{
                beginAtZero:true,
                ticks:{color:'rgba(255,255,255,0.6)'},
                grid:{color:'rgba(255,255,255,0.1)'}
              },
              x:{
                ticks:{color:'rgba(255,255,255,0.6)'},
                grid:{display:false}
              }
            }
          }
        }); 
      }
      
      // GrÃ¡fico de estado
      const ctx2 = document.getElementById('chart-status').getContext('2d'); 
      if(chartStatus){ 
        chartStatus.data.datasets[0].data=[statusCounts.vencida,statusCounts.alerta,statusCounts.normal]; 
        chartStatus.update('active'); 
      } else { 
        chartStatus = new Chart(ctx2, {
          type:'doughnut', 
          data:{
            labels:['Vencidas','Alerta (7d)','Normal'], 
            datasets:[{
              data:[statusCounts.vencida,statusCounts.alerta,statusCounts.normal], 
              backgroundColor:['#ef4444','#f59e0b','#06b6d4'],
              borderWidth:0,
              hoverOffset:10
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:{
              animateRotate: true,
              animateScale: true,
              duration: 1500,
              easing: 'easeOutBounce'
            },
            plugins:{
              legend:{
                display:true,
                position:'bottom',
                labels:{
                  color:'rgba(255,255,255,0.8)', 
                  padding:15,
                  font:{size:12}
                }
              },
              tooltip:{
                backgroundColor:'rgba(0,0,0,0.8)',
                padding:12,
                cornerRadius:8,
                bodyColor:'#fff'
              }
            }
          }
        }); 
      }
      
      // GrÃ¡fico de distribuciÃ³n por servicio
      const serviceCounts = {};
      allAccounts.forEach(a=>{
        const servicio = (a.servicio || 'Sin especificar').toLowerCase();
        const key = servicio.charAt(0).toUpperCase() + servicio.slice(1);
        serviceCounts[key] = (serviceCounts[key] || 0) + 1;
      });
      
      const serviceLabels = Object.keys(serviceCounts);
      const serviceData = Object.values(serviceCounts);
      
      // Colores dinÃ¡micos para servicios
      const serviceColors = [
        '#e50914', // Netflix rojo
        '#113ccf', // Disney+ azul
        '#a13eea', // HBO Max morado
        '#00e087', // Spotify verde
        '#ff6b35', // Amazon naranja
        '#1db954', // Otro verde
        '#f59e0b', // Amarillo
        '#ec4899', // Rosa
        '#8b5cf6', // PÃºrpura
        '#06b6d4'  // Cyan
      ];
      
      const ctx3 = document.getElementById('chart-services').getContext('2d');
      if(chartServices){
        chartServices.data.labels = serviceLabels;
        chartServices.data.datasets[0].data = serviceData;
        chartServices.update('active');
      } else {
        chartServices = new Chart(ctx3, {
          type:'pie',
          data:{
            labels:serviceLabels,
            datasets:[{
              data:serviceData,
              backgroundColor:serviceColors.slice(0, serviceLabels.length),
              borderWidth:2,
              borderColor:'rgba(0,0,0,0.5)',
              hoverOffset:15
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:{
              animateRotate: true,
              animateScale: true,
              duration: 1500,
              easing: 'easeInOutQuart'
            },
            plugins:{
              legend:{
                display:true,
                position:'bottom',
                labels:{
                  color:'rgba(255,255,255,0.8)',
                  padding:10,
                  font:{size:11},
                  generateLabels: function(chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                      return data.labels.map((label, i) => {
                        const value = data.datasets[0].data[i];
                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return {
                          text: `${label}: ${value} (${percentage}%)`,
                          fillStyle: data.datasets[0].backgroundColor[i],
                          hidden: false,
                          index: i
                        };
                      });
                    }
                    return [];
                  }
                }
              },
              tooltip:{
                backgroundColor:'rgba(0,0,0,0.9)',
                padding:12,
                cornerRadius:8,
                bodyColor:'#fff',
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} cuentas (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
      
      // GrÃ¡fico de precios
      const priceRanges = {'$0-$5':0, '$5-$10':0, '$10-$15':0, '$15+':0};
      allAccounts.forEach(a=>{
        const p = parseFloat(a.precio)||0;
        if(p < 5) priceRanges['$0-$5']++;
        else if(p < 10) priceRanges['$5-$10']++;
        else if(p < 15) priceRanges['$10-$15']++;
        else priceRanges['$15+']++;
      });
      
      const ctx4 = document.getElementById('chart-prices').getContext('2d');
      if(chartPrices){
        chartPrices.data.datasets[0].data = Object.values(priceRanges);
        chartPrices.update('active');
      } else {
        chartPrices = new Chart(ctx4, {
          type:'bar',
          data:{
            labels:Object.keys(priceRanges),
            datasets:[{
              label:'Cuentas',
              data:Object.values(priceRanges),
              backgroundColor:'rgba(139,92,246,0.7)',
              borderColor:'#8b5cf6',
              borderWidth:2,
              borderRadius: 8,
              hoverBackgroundColor:'rgba(139,92,246,0.9)'
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:{
              duration: 1200,
              easing: 'easeInOutQuart',
              delay: (context) => {
                let delay = 0;
                if (context.type === 'data' && context.mode === 'default') {
                  delay = context.dataIndex * 80;
                }
                return delay;
              }
            },
            plugins:{
              legend:{display:false},
              tooltip:{
                backgroundColor:'rgba(139,92,246,0.9)',
                titleColor:'#fff',
                bodyColor:'#fff',
                borderColor:'#8b5cf6',
                borderWidth:1,
                cornerRadius:8,
                padding:12
              }
            },
            scales:{
              y:{
                beginAtZero:true,
                ticks:{color:'rgba(255,255,255,0.6)', stepSize:1},
                grid:{color:'rgba(255,255,255,0.1)'}
              },
              x:{
                ticks:{color:'rgba(255,255,255,0.6)'},
                grid:{display:false}
              }
            }
          }
        });
      }
      
      // GrÃ¡fico de tendencia de ingresos
      const revenueByMonth = months.map(m => {
        return allAccounts
          .filter(a=> a.fechaCompra && (a.fechaCompra.substring(5,7)+'/'+a.fechaCompra.substring(0,4))===m)
          .reduce((sum, a) => sum + (parseFloat(a.precio)||0), 0);
      });
      
      const ctx5 = document.getElementById('chart-revenue-trend').getContext('2d');
      if(chartRevenueTrend){
        chartRevenueTrend.data.datasets[0].data = revenueByMonth;
        chartRevenueTrend.update('active');
      } else {
        chartRevenueTrend = new Chart(ctx5, {
          type:'line',
          data:{
            labels:months,
            datasets:[{
              label:'Ingresos',
              data:revenueByMonth,
              backgroundColor:'rgba(34,197,94,0.1)',
              borderColor:'#22c55e',
              borderWidth:3,
              fill:true,
              tension:0.4,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor:'#22c55e',
              pointBorderColor:'#fff',
              pointBorderWidth:2
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            animation:{
              duration: 1500,
              easing: 'easeInOutCubic',
              x: {
                type: 'number',
                easing: 'easeInOutCubic',
                duration: 1500,
                from: NaN,
                delay(ctx) {
                  if (ctx.type !== 'data' || ctx.xStarted) {
                    return 0;
                  }
                  ctx.xStarted = true;
                  return ctx.index * 100;
                }
              },
              y: {
                type: 'number',
                easing: 'easeInOutCubic',
                duration: 1500,
                from: 0,
                delay(ctx) {
                  if (ctx.type !== 'data' || ctx.yStarted) {
                    return 0;
                  }
                  ctx.yStarted = true;
                  return ctx.index * 100;
                }
              }
            },
            plugins:{
              legend:{display:false},
              tooltip:{
                backgroundColor:'rgba(34,197,94,0.9)',
                titleColor:'#fff',
                bodyColor:'#fff',
                borderColor:'#22c55e',
                borderWidth:1,
                cornerRadius:8,
                padding:12,
                callbacks: {
                  label: function(context) {
                    return 'Ingresos: $' + context.parsed.y.toFixed(2);
                  }
                }
              }
            },
            scales:{
              y:{
                beginAtZero:true,
                ticks:{
                  color:'rgba(255,255,255,0.6)',
                  callback: function(value) {
                    return '$' + value.toFixed(2);
                  }
                },
                grid:{color:'rgba(255,255,255,0.1)'}
              },
              x:{
                ticks:{color:'rgba(255,255,255,0.6)'},
                grid:{display:false}
              }
            }
          }
        });
      }
    }

    function renderUpcomingAccounts(){
      const tbody = document.getElementById('upcoming-accounts-tbody');
      const emptyDiv = document.getElementById('upcoming-empty');
      tbody.innerHTML = '';
      
      const filtered = allAccounts.filter(a=>{
        const days = calculateDaysRemaining(a.fechaCaducidad).days;
        return days !== null && days >= 0 && days <= upcomingFilterDays;
      }).sort((a,b)=>{
        const daysA = calculateDaysRemaining(a.fechaCaducidad).days || 999;
        const daysB = calculateDaysRemaining(b.fechaCaducidad).days || 999;
        return daysA - daysB;
      });
      
      if(filtered.length === 0){
        tbody.innerHTML = '';
        emptyDiv.classList.remove('hidden');
        return;
      }
      
      emptyDiv.classList.add('hidden');
      
      filtered.forEach(a=>{
        const days = calculateDaysRemaining(a.fechaCaducidad).days;
        let statusClass = 'status-normal';
        let statusText = 'âœ… Normal';
        
        if(days < 0){
          statusClass = 'status-vencida';
          statusText = 'ğŸ”´ Vencida';
        } else if(days <= 3){
          statusClass = 'status-vencida';
          statusText = 'ğŸ”´ Urgente';
        } else if(days <= 7){
          statusClass = 'status-alerta';
          statusText = 'âš ï¸ Alerta';
        }

        // Verificar si hay cuentas agrupadas para este usuario
        const grouped = findGroupedAccounts(a.id);
        const hasGrouped = grouped.length > 0;
        
        const tr = document.createElement('tr');
        tr.className = 'table-row border-b border-white/5';
        tr.innerHTML = `
          <td class="py-3 px-2">
            <span class="status-badge ${statusClass}">${statusText}</span>
          </td>
          <td class="py-3 px-2 font-semibold">
            ${a.propietario || 'Sin propietario'}
            ${hasGrouped ? `<span class="grouped-badge">ğŸ“¦ +${grouped.length}</span>` : ''}
          </td>
          <td class="py-3 px-2 muted">${a.correo || 'N/A'}</td>
          <td class="py-3 px-2 text-green-400 font-bold">$${(parseFloat(a.precio)||0).toFixed(2)}</td>
          <td class="py-3 px-2">${a.fechaCaducidad || 'N/A'}</td>
          <td class="py-3 px-2 ${days < 0 ? 'text-red-400' : days <= 7 ? 'text-orange-400' : 'text-cyan-400'} font-bold">
            ${days < 0 ? `Hace ${Math.abs(days)} dÃ­a${Math.abs(days)>1?'s':''}` : `${days} dÃ­a${days>1?'s':''}`}
          </td>
          <td class="py-3 px-2 text-center">
            <div class="flex gap-2 justify-center">
              ${a.telefono ? `<button onclick="openNotificationModal('${a.id}')" class="px-3 py-1 text-xs bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg transition-all" title="${hasGrouped ? 'Notificar - Hay ' + (grouped.length + 1) + ' cuentas agrupadas' : 'Enviar notificaciÃ³n WhatsApp'}">
                ğŸ“±${hasGrouped ? ' (' + (grouped.length + 1) + ')' : ''}
              </button>` : ''}
              <a href="accounts.html" class="px-3 py-1 text-xs bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg transition-all">
                Ver
              </a>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

  // Mostrar modal con detalle de ingresos Ãºltimos 30 dÃ­as para depuraciÃ³n
  function openRevenue30Modal(){ 
    const details = window.__revenue30_details || []; 
    const modal = document.getElementById('revenue30-modal'); 
    const tbody = document.getElementById('revenue30-tbody'); 
    tbody.innerHTML=''; 
    let sum=0; 
    details.forEach(d=>{ 
      if(d.included && d.included!=='no'){
        const tr = document.createElement('tr'); 
        const fechaCompra = d.fechaCompraRaw || ''; 
        tr.innerHTML = `
          <td class="px-2 py-1 border-b border-white/10">${fechaCompra}</td>
          <td class="px-2 py-1 border-b border-white/10">${d.propietario||''}</td>
          <td class="px-2 py-1 border-b border-white/10 text-green-400 font-semibold">$${d.precio||'0'}</td>
        `; 
        tbody.appendChild(tr); 
        sum += parseFloat(d.precio)||0; 
      }
    }); 
    document.getElementById('revenue30-sum').textContent = `$${sum.toFixed(2)}`; 
    modal.classList.remove('hidden'); 
  }
  
  function closeRevenue30Modal(){ 
    document.getElementById('revenue30-modal').classList.add('hidden'); 
  }

    // Perfil modal
    function openProfileModal(){ 
      document.getElementById('profile-modal').classList.remove('hidden'); 
      document.getElementById('profile-msg').classList.add('hidden'); 
      loadProfileInfo(); 
    }
    
    function closeProfileModal(){ 
      document.getElementById('profile-modal').classList.add('hidden'); 
    }
    
    async function loadProfileInfo(){ 
      const emailEl = document.getElementById('profile-email'); 
      emailEl.textContent='Cargando...'; 
      if(useSupabase && window.__supabase){ 
        try{ 
          const { data } = await window.__supabase.auth.getUser(); 
          const user = data?.user || null; 
          emailEl.textContent = user?.email || 'Sin correo'; 
        }catch(err){ 
          console.error(err); 
          emailEl.textContent='Error'; 
        } 
      } else { 
        const users = JSON.parse(localStorage.getItem('netflix_users')||'[]'); 
        const u = users.find(x=>x.id===currentUserId); 
        emailEl.textContent = u?.email || 'Usuario local'; 
      } 
    }

    document.getElementById('change-password-form').addEventListener('submit', async (e)=>{ 
      e.preventDefault(); 
      const msgEl = document.getElementById('profile-msg'); 
      msgEl.className='text-sm mt-2 hidden'; 
      const p1 = document.getElementById('new-password').value; 
      const p2 = document.getElementById('confirm-password').value; 
      if(!p1 || p1.length<6){ 
        msgEl.textContent='La contraseÃ±a debe tener al menos 6 caracteres.'; 
        msgEl.classList.remove('hidden'); 
        return; 
      } 
      if(p1!==p2){ 
        msgEl.textContent='Las contraseÃ±as no coinciden.'; 
        msgEl.classList.remove('hidden'); 
        return; 
      } 
      try{ 
        if(useSupabase && window.__supabase){ 
          const { data, error } = await window.__supabase.auth.updateUser({ password: p1 }); 
          if(error) throw error; 
          msgEl.textContent='ContraseÃ±a actualizada.'; 
          msgEl.classList.remove('hidden'); 
        } else { 
          const users = JSON.parse(localStorage.getItem('netflix_users')||'[]'); 
          const idx = users.findIndex(x=>x.id===currentUserId); 
          if(idx===-1){ 
            msgEl.textContent='Usuario local no encontrado.'; 
            msgEl.classList.remove('hidden'); 
            return; 
          } 
          users[idx].password = p1; 
          localStorage.setItem('netflix_users', JSON.stringify(users)); 
          msgEl.textContent='ContraseÃ±a (local) actualizada.'; 
          msgEl.classList.remove('hidden'); 
        } 
        document.getElementById('new-password').value=''; 
        document.getElementById('confirm-password').value=''; 
      }catch(err){ 
        msgEl.textContent = err.message || String(err); 
        msgEl.classList.remove('hidden'); 
      } 
    });

    // ==================== SISTEMA DE NOTIFICACIONES ====================
    let currentNotificationAccount = null;
    let selectedNotificationType = null;
    let groupedAccountsForNotification = []; // Para almacenar cuentas agrupadas
    let pendingAccountId = null; // ID de la cuenta que activÃ³ el modal de selecciÃ³n
    let isGroupedNotification = false; // Flag para saber si es notificaciÃ³n agrupada

    // Plantillas de mensajes por defecto
    const defaultTemplates = {
      pago_3dias: `Hola {propietario},

Te recordamos que tu pago de {servicio} vence en *3 dÃ­as* ({fechaPago}).

ğŸ’µ Monto: {precio}

Por favor realiza tu pago a tiempo para evitar interrupciones en el servicio.

Â¡Gracias por tu preferencia! ğŸ˜Š`,

      pago_2dias: `Hola {propietario},

âš ï¸ Tu pago de {servicio} vence en *2 dÃ­as* ({fechaPago}).

ğŸ’µ Monto: {precio}

Te pedimos realizar el pago pronto para mantener tu servicio activo.

Â¡Gracias! ğŸ™`,

      pago_1dia: `Hola {propietario},

ğŸš¨ *IMPORTANTE:* Tu pago de {servicio} vence *MAÃ‘ANA* ({fechaPago}).

ğŸ’µ Monto: {precio}

Por favor realiza tu pago cuanto antes para evitar la suspensiÃ³n del servicio.

Gracias por tu atenciÃ³n.`,

      pago_hoy: `Hola {propietario},

ğŸ”´ *URGENTE:* Tu pago de {servicio} vence *HOY* ({fechaPago}).

ğŸ’µ Monto: {precio}

Es necesario que realices el pago hoy mismo para mantener tu servicio activo.

Â¡Gracias!`,

      pago_atrasado: `Hola {propietario},

Notamos que tu pago de {servicio} estÃ¡ *atrasado* desde {fechaPago}.

ğŸ’µ Monto: {precio}

Para reactivar tu servicio, te pedimos regularizar tu pago lo antes posible.

Quedamos atentos. Gracias.`,

      confirmacion_pago: `Hola {propietario},

âœ… *Â¡Pago confirmado!*

Hemos recibido tu pago de *{precio}* por el servicio de {servicio}.

ğŸ“… PrÃ³ximo pago: {fechaPago}
ğŸ“… Servicio vÃ¡lido hasta: {fechaCaducidad}

Â¡Gracias por tu pago puntual! ğŸ‰`,

      renovacion_proxima: `Hola {propietario},

Te informamos que tu cuenta de {servicio} estÃ¡ prÃ³xima a vencer el *{fechaCaducidad}*.

Si deseas renovar tu servicio, contÃ¡ctanos para procesar tu renovaciÃ³n.

ğŸ’µ Precio de renovaciÃ³n: {precio}

Â¡Gracias por confiar en nosotros! ğŸ˜Š`,

      personalizado: '',

      // Plantillas para notificaciones agrupadas
      pago_agrupado: `Hola {propietario},

    Te recordamos que tienes *{cantidad_cuentas} cuentas* que vencen prÃ³ximamente el *{fechaCaducidad}*.

    ğŸ“‹ *Detalle de tus cuentas:*{cuentas_lista}

    ğŸ’° *Total a pagar: {total_precio}*

    Por favor realiza tu pago a tiempo para evitar interrupciones en tus servicios.

    Â¡Gracias por tu preferencia! ğŸ˜Š`,

      renovacion_proxima_agrupada: `Hola {propietario},

    Te informamos que tienes *{cantidad_cuentas} cuentas* prÃ³ximas a vencer el *{fechaCaducidad}*.

    ğŸ“‹ *Detalle de tus cuentas:*{cuentas_lista}

    ğŸ’° *Total para renovaciÃ³n: {total_precio}*

    Si deseas renovar tus servicios, contÃ¡ctanos para procesar la renovaciÃ³n.

    Â¡Gracias por confiar en nosotros! ğŸ˜Š`,

      confirmacion_pago_agrupada: `Hola {propietario},

    âœ… *Â¡Pago confirmado!*

    Hemos recibido tu pago por *{cantidad_cuentas} cuentas*.

    ğŸ“‹ *Cuentas actualizadas:*{cuentas_lista}

    ğŸ’° *Total pagado: {total_precio}*

    Â¡Gracias por tu pago puntual! ğŸ‰`
    };

    function formatDate(date){ 
      if(!date) return ''; 
      const d = new Date(date+'T00:00:00'); 
      if(isNaN(d.getTime())) return ''; 
      const y=d.getFullYear(); 
      const m=String(d.getMonth()+1).padStart(2,'0'); 
      const day=String(d.getDate()).padStart(2,'0'); 
      return `${day}/${m}/${y}`; 
    }

    function processTemplate(template, account) {
      return template
        .replace(/{propietario}/g, account.propietario || 'Cliente')
        .replace(/{servicio}/g, account.servicio || 'Netflix')
        .replace(/{precio}/g, `$${(parseFloat(account.precio) || 0).toFixed(2)}`)
        .replace(/{fechaPago}/g, formatDate(account.fechaPago))
        .replace(/{fechaCaducidad}/g, formatDate(account.fechaCaducidad))
        .replace(/{correo}/g, account.correo || 'N/A')
        .replace(/{telefono}/g, account.telefono || 'N/A');
    }

    function calculateDaysToPayment(paymentDateString){ 
      if(!paymentDateString) return {display:'No definido', days:null}; 
      const p=new Date(paymentDateString+'T00:00:00'); 
      const t=new Date(); 
      p.setHours(0,0,0,0); 
      t.setHours(0,0,0,0); 
      const diff=Math.ceil((p.getTime()-t.getTime())/(1000*60*60*24)); 
      return {days: diff}; 
    }

    // FunciÃ³n para encontrar cuentas agrupadas (mismo usuario y fecha de caducidad)
    function findGroupedAccounts(accountId) {
      const account = allAccounts.find(a => String(a.id) === String(accountId));
      if (!account || !account.telefono) return [];

      const accountDate = account.fechaCaducidad;
      if (!accountDate) return [];

      // Buscar todas las cuentas del mismo propietario con el mismo telÃ©fono y misma fecha de caducidad
      const grouped = allAccounts.filter(a => {
        return String(a.id) !== String(accountId) && 
               a.telefono === account.telefono &&
               a.propietario === account.propietario &&
               a.fechaCaducidad === accountDate;
      });

      return grouped;
    }

    // Abrir modal de selecciÃ³n de notificaciÃ³n (individual o grupal)
    function openNotificationChoiceModal(accountId) {
      const account = allAccounts.find(a => String(a.id) === String(accountId));
      if (!account) {
        alert('Cuenta no encontrada.');
        return;
      }

      pendingAccountId = accountId;
      const grouped = findGroupedAccounts(accountId);
      
      document.getElementById('choice-propietario').textContent = account.propietario || 'Sin nombre';
      document.getElementById('choice-telefono').textContent = account.telefono;

      // Si hay cuentas agrupadas, mostrar informaciÃ³n
      if (grouped.length > 0) {
        groupedAccountsForNotification = [account, ...grouped];
        
        const accountsList = document.getElementById('grouped-accounts-list');
        accountsList.innerHTML = '';
        
        groupedAccountsForNotification.forEach(acc => {
          const div = document.createElement('div');
          div.className = 'account-list-item';
          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div class="flex-1">
                <div class="text-sm font-semibold">${acc.servicio || 'Netflix'}</div>
                <div class="text-xs text-white/60">${acc.correo || 'Sin correo'}</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-bold text-green-400">$${(parseFloat(acc.precio) || 0).toFixed(2)}</div>
                <div class="text-xs text-white/60">${acc.fechaCaducidad}</div>
              </div>
            </div>
          `;
          accountsList.appendChild(div);
        });

        document.getElementById('grouped-count').textContent = groupedAccountsForNotification.length;
        document.getElementById('grouped-accounts-info').classList.remove('hidden');
        document.getElementById('btn-notify-grouped').classList.remove('hidden');
      } else {
        groupedAccountsForNotification = [account];
        document.getElementById('grouped-accounts-info').classList.add('hidden');
        document.getElementById('btn-notify-grouped').classList.add('hidden');
      }

      document.getElementById('notification-choice-modal').classList.remove('hidden');
    }

    function closeNotificationChoiceModal() {
      document.getElementById('notification-choice-modal').classList.add('hidden');
      pendingAccountId = null;
      groupedAccountsForNotification = [];
    }

    function proceedWithSingleNotification() {
      closeNotificationChoiceModal();
      if (pendingAccountId) {
        openNotificationModalDirect(pendingAccountId, false);
      }
    }

    function proceedWithGroupedNotification() {
      closeNotificationChoiceModal();
      if (pendingAccountId) {
        openNotificationModalDirect(pendingAccountId, true);
      }
    }

    async function openNotificationModal(accountId) {
      try {
        const account = allAccounts.find(a => String(a.id) === String(accountId));
        if (!account) {
          alert('Cuenta no encontrada.');
          return;
        }

        if (!account.telefono || account.telefono.trim() === '') {
          alert('Esta cuenta no tiene nÃºmero de telÃ©fono registrado.');
          return;
        }

        // Verificar si hay cuentas agrupadas
        const grouped = findGroupedAccounts(accountId);
        
        if (grouped.length > 0) {
          // Si hay cuentas agrupadas, mostrar modal de selecciÃ³n
          openNotificationChoiceModal(accountId);
        } else {
          // Si no hay agrupadas, ir directo al modal de notificaciÃ³n
          openNotificationModalDirect(accountId, false);
        }
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    async function openNotificationModalDirect(accountId, isGrouped) {
      try {
        const account = allAccounts.find(a => String(a.id) === String(accountId));
        if (!account) {
          alert('Cuenta no encontrada.');
          return;
        }

        currentNotificationAccount = account;
        selectedNotificationType = null;
        isGroupedNotification = isGrouped;

        // Si es agrupado y no tenemos las cuentas, las buscamos
        if (isGrouped && groupedAccountsForNotification.length === 0) {
          const grouped = findGroupedAccounts(accountId);
          groupedAccountsForNotification = [account, ...grouped];
        }

        const displayText = isGrouped 
          ? `${account.propietario || 'Sin nombre'} (${groupedAccountsForNotification.length} cuentas)`
          : account.propietario || 'Sin nombre';

        document.getElementById('notify-propietario').textContent = displayText;
        document.getElementById('notify-telefono').textContent = account.telefono;

        document.getElementById('message-preview-container').classList.add('hidden');
        document.getElementById('notification-warning').classList.add('hidden');
        document.getElementById('send-whatsapp-btn').disabled = true;
        document.getElementById('custom-message-container').classList.add('hidden');

        // Remover clase selected de todas las opciones
        document.querySelectorAll('.notification-option').forEach(btn => {
          btn.classList.remove('selected');
        });

        document.getElementById('notification-modal').classList.remove('hidden');
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    function closeNotificationModal() {
      document.getElementById('notification-modal').classList.add('hidden');
      currentNotificationAccount = null;
      selectedNotificationType = null;
      isGroupedNotification = false;
      groupedAccountsForNotification = [];
    }

    // FunciÃ³n para generar mensaje agrupado
    function processGroupedTemplate(template, accounts) {
      if (!accounts || accounts.length === 0) return '';
      
      const firstAccount = accounts[0];
      let message = template
        .replace(/{propietario}/g, firstAccount.propietario || 'Cliente')
        .replace(/{telefono}/g, firstAccount.telefono || 'N/A');

      // Generar lista de cuentas
      let accountsList = '';
      let totalPrice = 0;

      accounts.forEach((acc, index) => {
        const price = parseFloat(acc.precio) || 0;
        totalPrice += price;
        accountsList += `\n${index + 1}. *${acc.servicio || 'Netflix'}* (${acc.correo || 'Sin correo'})\n   ğŸ’µ Precio: $${price.toFixed(2)}\n   ğŸ“… Vence: ${acc.fechaCaducidad || 'N/A'}`;
      });

      message = message
        .replace(/{cuentas_lista}/g, accountsList)
        .replace(/{total_precio}/g, `$${totalPrice.toFixed(2)}`)
        .replace(/{cantidad_cuentas}/g, accounts.length.toString())
        .replace(/{fechaCaducidad}/g, firstAccount.fechaCaducidad || 'N/A');

      return message;
    }

    function selectNotificationType(type, el) {
      if (!currentNotificationAccount) return;

      selectedNotificationType = type;
      const account = currentNotificationAccount;
      
      // Remover clase selected de todas las opciones
      document.querySelectorAll('.notification-option').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Agregar clase selected a la opciÃ³n clickeada (el viene de onclick="..., this")
      try{ if(el && el.classList) el.classList.add('selected'); }catch(e){}
      
      let message = '';
      let warning = '';
      let shouldWarn = false;

      const paymentInfo = calculateDaysToPayment(account.fechaPago);
      const expiryInfo = calculateDaysRemaining(account.fechaCaducidad);

      // Si es notificaciÃ³n agrupada, usar plantillas especiales
      if (isGroupedNotification && groupedAccountsForNotification.length > 0) {
        switch(type) {
          case 'renovacion_proxima':
            message = processGroupedTemplate(defaultTemplates.renovacion_proxima_agrupada, groupedAccountsForNotification);
            break;
          case 'pago_3dias':
          case 'pago_2dias':
          case 'pago_1dia':
          case 'pago_hoy':
          case 'pago_atrasado':
            message = processGroupedTemplate(defaultTemplates.pago_agrupado, groupedAccountsForNotification);
            break;
          case 'confirmacion_pago':
            message = processGroupedTemplate(defaultTemplates.confirmacion_pago_agrupada, groupedAccountsForNotification);
            break;
          case 'personalizado':
            message = '';
            document.getElementById('custom-message-container').classList.remove('hidden');
            document.getElementById('custom-message-input').value = '';
            document.getElementById('custom-message-input').focus();
            document.getElementById('custom-message-input').addEventListener('input', (e) => {
              document.getElementById('message-preview').textContent = e.target.value || '(vacÃ­o)';
              document.getElementById('send-whatsapp-btn').disabled = !e.target.value.trim();
            });
            break;
        }
      } else {
        // Mensajes individuales (lÃ³gica existente)
        switch(type) {
          case 'pago_3dias':
            if (paymentInfo.days === null || paymentInfo.days > 3 || paymentInfo.days < 2) {
              warning = 'El pago no vence en 3 dÃ­as. Verifica la fecha de pago antes de enviar.';
              shouldWarn = true;
            }
            message = processTemplate(defaultTemplates.pago_3dias, account);
            break;

          case 'pago_2dias':
            if (paymentInfo.days === null || paymentInfo.days > 2 || paymentInfo.days < 1) {
              warning = 'El pago no vence en 2 dÃ­as. Verifica la fecha de pago antes de enviar.';
              shouldWarn = true;
            }
            message = processTemplate(defaultTemplates.pago_2dias, account);
            break;

          case 'pago_1dia':
            if (paymentInfo.days === null || paymentInfo.days !== 1) {
              warning = 'El pago no vence maÃ±ana. Verifica la fecha de pago antes de enviar.';
              shouldWarn = true;
            }
            message = processTemplate(defaultTemplates.pago_1dia, account);
            break;

          case 'pago_hoy':
            if (paymentInfo.days === null || paymentInfo.days !== 0) {
              warning = 'El pago no vence hoy. Verifica la fecha de pago antes de enviar.';
              shouldWarn = true;
            }
            message = processTemplate(defaultTemplates.pago_hoy, account);
            break;

          case 'pago_atrasado':
            if (paymentInfo.days === null || paymentInfo.days >= 0) {
              warning = 'El pago no estÃ¡ atrasado. Este mensaje no es apropiado.';
              shouldWarn = true;
            }
            message = processTemplate(defaultTemplates.pago_atrasado, account);
            break;

          case 'renovacion_proxima':
            if (expiryInfo.days === null || expiryInfo.days > 7 || expiryInfo.days < 0) {
              warning = 'La cuenta no estÃ¡ prÃ³xima a vencer. Verifica la fecha de caducidad.';
              shouldWarn = true;
            }
            message = processTemplate(defaultTemplates.renovacion_proxima, account);
            break;

          case 'confirmacion_pago':
            message = processTemplate(defaultTemplates.confirmacion_pago, account);
            break;

          case 'personalizado':
            message = '';
            document.getElementById('custom-message-container').classList.remove('hidden');
            document.getElementById('custom-message-input').value = '';
            document.getElementById('custom-message-input').focus();
            document.getElementById('custom-message-input').addEventListener('input', (e) => {
              document.getElementById('message-preview').textContent = e.target.value || '(vacÃ­o)';
              document.getElementById('send-whatsapp-btn').disabled = !e.target.value.trim();
            });
            break;
        }
      }

      document.getElementById('message-preview').textContent = message || '(vacÃ­o)';
      document.getElementById('message-preview-container').classList.remove('hidden');

      if (shouldWarn) {
        document.getElementById('warning-text').textContent = warning;
        document.getElementById('notification-warning').classList.remove('hidden');
      } else {
        document.getElementById('notification-warning').classList.add('hidden');
      }

      if (type === 'personalizado') {
        document.getElementById('send-whatsapp-btn').disabled = true;
      } else {
        document.getElementById('send-whatsapp-btn').disabled = false;
      }
    }

    // Enviar notificaciÃ³n usando WAHA API (automÃ¡tico)
    async function sendWhatsAppMessage() {
      if (!currentNotificationAccount || !selectedNotificationType) return;

      let message = '';
      if (selectedNotificationType === 'personalizado') {
        message = document.getElementById('custom-message-input').value.trim();
      } else {
        message = document.getElementById('message-preview').textContent;
      }

      if (!message) {
        alert('El mensaje estÃ¡ vacÃ­o.');
        return;
      }

      // Deshabilitar botÃ³n para evitar doble envÃ­o
      const sendBtn = document.getElementById('send-whatsapp-btn');
      const originalText = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = 'ğŸ“¤ Enviando...';

      try {
        const jwt = localStorage.getItem('jwt');
        
        // Check rate limit first
        const rateLimitResponse = await fetch(`${ADMIN_BASE_URL}/admin/automation/rate-limit`, {
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          }
        });

        if (rateLimitResponse.ok) {
          const rateLimit = await rateLimitResponse.json();
          if (!rateLimit.canSend) {
            throw new Error(`LÃ­mite de envÃ­os alcanzado: ${rateLimit.currentCount}/${rateLimit.limit} por hora. Espera unos minutos.`);
          }
        }

        // Preparar data para envÃ­o
        const phone = currentNotificationAccount.telefono;
        
        // Send using WAHA API
        const response = await fetch(`${ADMIN_BASE_URL}/admin/whatsapp/send-custom`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phone: phone,
            template: message
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al enviar mensaje');
        }

        const result = await response.json();

        if (result.success) {
          // Track the notification
          await fetch(`${ADMIN_BASE_URL}/admin/automation/track`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${jwt}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              account_id: currentNotificationAccount.id,
              notification_type: selectedNotificationType,
              success: true,
              phone: phone,
              message_id: result.messageId,
              metadata: {
                is_grouped: isGroupedNotification,
                accounts_count: isGroupedNotification ? groupedAccountsForNotification.length : 1
              }
            })
          });

          alert(`âœ… Â¡NotificaciÃ³n enviada exitosamente a ${currentNotificationAccount.propietario}!`);
          closeNotificationModal();
          
          // Recargar estadÃ­sticas si el panel estÃ¡ visible
          if (document.getElementById('automation-config-panel').classList.contains('hidden') === false) {
            await loadTodayStats();
          }
        } else {
          throw new Error(result.error || 'Error desconocido al enviar');
        }

      } catch (err) {
        console.error('Error sending WhatsApp notification:', err);
        alert(`âŒ Error al enviar notificaciÃ³n:\n${err.message}\n\nÂ¿Deseas intentar con WhatsApp Web (manual)?`);
        
        // Track failed notification
        try {
          const jwt = localStorage.getItem('jwt');
          await fetch(`${ADMIN_BASE_URL}/admin/automation/track`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${jwt}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              account_id: currentNotificationAccount.id,
              notification_type: selectedNotificationType,
              success: false,
              error_message: err.message,
              phone: currentNotificationAccount.telefono
            })
          });
        } catch (trackErr) {
          console.error('Error tracking failed notification:', trackErr);
        }
        
        // Ofrecer fallback a WhatsApp Web
        if (confirm('Â¿Abrir WhatsApp Web para enviar manualmente?')) {
          const phone = currentNotificationAccount.telefono.replace(/\D/g, '');
          const encodedMessage = encodeURIComponent(message);
          const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
          window.open(whatsappUrl, '_blank');
        }
      } finally {
        // Restaurar botÃ³n
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('notification-modal')?.addEventListener('click', function(e) {
      if (e.target === this) closeNotificationModal();
    });

    // ==================== FIN SISTEMA DE NOTIFICACIONES ====================

    // Inicializar
    (async ()=>{ 
      await init(); 
      await update(); 
      // Actualizar cada 60 segundos
      setInterval(update, 60000);
    })();

    // hook botÃ³n debug
    document.getElementById('btn-debug-30d').addEventListener('click', ()=> openRevenue30Modal());

    // =====================================================
    // AUTOMATION CONFIG FUNCTIONS
    // =====================================================

    let currentAutomationConfig = null;
    let automationPanelExpanded = true;

    // Toggle panel visibility
    function toggleAutomationPanel() {
      automationPanelExpanded = !automationPanelExpanded;
      const content = document.getElementById('automation-panel-content');
      const toggleText = document.getElementById('toggle-panel-text');
      
      if (automationPanelExpanded) {
        content.style.display = 'block';
        toggleText.textContent = 'ğŸ”½ Minimizar';
      } else {
        content.style.display = 'none';
        toggleText.textContent = 'ğŸ”¼ Expandir';
      }
    }

    // Load automation configuration
    async function loadAutomationConfig() {
      try {
        const jwt = localStorage.getItem('jwt');
        const response = await fetch(`${ADMIN_BASE_URL}/admin/automation/config`, {
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) throw new Error('Error al cargar configuraciÃ³n');

        const config = await response.json();
        currentAutomationConfig = config;

        // Update UI
        updateAutomationUI(config);
        
        // Load stats
        await loadTodayStats();
        
        showTemporaryNotification('âœ… ConfiguraciÃ³n cargada correctamente', 'success');
      } catch (err) {
        console.error('Error loading automation config:', err);
        showTemporaryNotification('âŒ Error al cargar configuraciÃ³n: ' + err.message, 'error');
      }
    }

    // Update UI with current config
    function updateAutomationUI(config) {
      // Status badge
      const statusBadge = document.getElementById('system-status-badge');
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      
      if (config.status === 'active') {
        statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-300';
        statusIndicator.textContent = 'â—';
        statusText.textContent = 'Activo';
        document.getElementById('btn-pause').disabled = false;
        document.getElementById('btn-resume').disabled = true;
        document.getElementById('btn-maintenance').disabled = false;
      } else if (config.status === 'paused') {
        statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-orange-500/20 text-orange-300';
        statusIndicator.textContent = 'â¸';
        statusText.textContent = 'Pausado';
        document.getElementById('btn-pause').disabled = true;
        document.getElementById('btn-resume').disabled = false;
        document.getElementById('btn-maintenance').disabled = true;
      } else if (config.status === 'maintenance') {
        statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-300';
        statusIndicator.textContent = 'ğŸ”§';
        statusText.textContent = 'Mantenimiento';
        document.getElementById('btn-pause').disabled = true;
        document.getElementById('btn-resume').disabled = false;
        document.getElementById('btn-maintenance').disabled = true;
      }

      // Intervals
      const intervals = config.config.intervals || {};
      document.getElementById('interval-bulk').value = intervals.bulk || 3000;
      document.getElementById('interval-retry').value = intervals.retry || 5000;
      document.getElementById('interval-check').value = intervals.check || 60000;
      updateIntervalDisplay('bulk', intervals.bulk || 3000);
      updateIntervalDisplay('retry', intervals.retry || 5000);
      updateIntervalDisplay('check', intervals.check || 60000);

      // Notification types
      const notifTypes = config.config.notificationTypes || {};
      document.getElementById('notif-3-days').checked = notifTypes['3_days_before']?.enabled !== false;
      document.getElementById('interval-3-days').value = notifTypes['3_days_before']?.interval || 2000;
      
      document.getElementById('notif-2-days').checked = notifTypes['2_days_before']?.enabled !== false;
      document.getElementById('interval-2-days').value = notifTypes['2_days_before']?.interval || 2000;
      
      document.getElementById('notif-1-day').checked = notifTypes['1_day_before']?.enabled !== false;
      document.getElementById('interval-1-day').value = notifTypes['1_day_before']?.interval || 2000;
      
      document.getElementById('notif-due-today').checked = notifTypes['due_today']?.enabled !== false;
      document.getElementById('interval-due-today').value = notifTypes['due_today']?.interval || 1000;
      
      document.getElementById('notif-overdue').checked = notifTypes['overdue']?.enabled !== false;
      document.getElementById('interval-overdue').value = notifTypes['overdue']?.interval || 1000;
      
      document.getElementById('notif-renewal').checked = notifTypes['renewal']?.enabled !== false;
      document.getElementById('interval-renewal').value = notifTypes['renewal']?.interval || 3000;

      // Limits
      const limits = config.config.limits || {};
      document.getElementById('limit-per-hour').value = limits.maxPerHour || 50;
      document.getElementById('limit-retries').value = limits.maxRetries || 3;
      document.getElementById('limit-cooldown').value = limits.cooldownMinutes || 30;
    }

    // Update interval display
    function updateIntervalDisplay(type, value) {
      document.getElementById(`interval-${type}-value`).textContent = `${value}ms`;
    }

    // Load today's statistics
    async function loadTodayStats() {
      try {
        const jwt = localStorage.getItem('jwt');
        const response = await fetch(`${ADMIN_BASE_URL}/admin/automation/stats/today`, {
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) throw new Error('Error al cargar estadÃ­sticas');

        const stats = await response.json();
        
        document.getElementById('stat-sent-today').textContent = stats.total_sent || 0;
        document.getElementById('stat-failed-today').textContent = stats.total_failed || 0;
        document.getElementById('stat-pending-today').textContent = stats.total_pending || 0;
        
        // Load rate limit
        const rateLimitResponse = await fetch(`${ADMIN_BASE_URL}/admin/automation/rate-limit`, {
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (rateLimitResponse.ok) {
          const rateLimit = await rateLimitResponse.json();
          document.getElementById('stat-rate-limit').textContent = `${rateLimit.currentCount || 0}/${rateLimit.limit || 50}`;
        }
      } catch (err) {
        console.error('Error loading today stats:', err);
      }
    }

    // Pause automation
    async function pauseAutomation() {
      const reason = prompt('RazÃ³n de la pausa (opcional):');
      
      try {
        const jwt = localStorage.getItem('jwt');
        const response = await fetch(`${ADMIN_BASE_URL}/admin/automation/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: 'paused',
            paused_reason: reason || 'Pausado por el administrador'
          })
        });

        if (!response.ok) throw new Error('Error al pausar automatizaciÃ³n');

        await loadAutomationConfig();
        showTemporaryNotification('â¸ï¸ AutomatizaciÃ³n pausada correctamente', 'success');
      } catch (err) {
        console.error('Error pausing automation:', err);
        showTemporaryNotification('âŒ Error al pausar: ' + err.message, 'error');
      }
    }

    // Resume automation
    async function resumeAutomation() {
      try {
        const jwt = localStorage.getItem('jwt');
        const response = await fetch(`${ADMIN_BASE_URL}/admin/automation/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: 'active'
          })
        });

        if (!response.ok) throw new Error('Error al reanudar automatizaciÃ³n');

        await loadAutomationConfig();
        showTemporaryNotification('â–¶ï¸ AutomatizaciÃ³n reanudada correctamente', 'success');
      } catch (err) {
        console.error('Error resuming automation:', err);
        showTemporaryNotification('âŒ Error al reanudar: ' + err.message, 'error');
      }
    }

    // Set maintenance mode
    async function setMaintenanceMode() {
      if (!confirm('Â¿EstÃ¡s seguro de activar el modo mantenimiento? Las notificaciones automÃ¡ticas se detendrÃ¡n.')) {
        return;
      }

      try {
        const jwt = localStorage.getItem('jwt');
        const response = await fetch(`${ADMIN_BASE_URL}/admin/automation/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: 'maintenance',
            paused_reason: 'Modo mantenimiento activado'
          })
        });

        if (!response.ok) throw new Error('Error al activar modo mantenimiento');

        await loadAutomationConfig();
        showTemporaryNotification('ğŸ”§ Modo mantenimiento activado', 'success');
      } catch (err) {
        console.error('Error setting maintenance mode:', err);
        showTemporaryNotification('âŒ Error: ' + err.message, 'error');
      }
    }

    // Save automation configuration
    async function saveAutomationConfig() {
      try {
        // Build config object
        const config = {
          intervals: {
            bulk: parseInt(document.getElementById('interval-bulk').value),
            retry: parseInt(document.getElementById('interval-retry').value),
            check: parseInt(document.getElementById('interval-check').value)
          },
          limits: {
            maxPerHour: parseInt(document.getElementById('limit-per-hour').value),
            maxRetries: parseInt(document.getElementById('limit-retries').value),
            cooldownMinutes: parseInt(document.getElementById('limit-cooldown').value)
          },
          notificationTypes: {
            '3_days_before': {
              enabled: document.getElementById('notif-3-days').checked,
              priority: 3,
              interval: parseInt(document.getElementById('interval-3-days').value)
            },
            '2_days_before': {
              enabled: document.getElementById('notif-2-days').checked,
              priority: 3,
              interval: parseInt(document.getElementById('interval-2-days').value)
            },
            '1_day_before': {
              enabled: document.getElementById('notif-1-day').checked,
              priority: 2,
              interval: parseInt(document.getElementById('interval-1-day').value)
            },
            'due_today': {
              enabled: document.getElementById('notif-due-today').checked,
              priority: 1,
              interval: parseInt(document.getElementById('interval-due-today').value)
            },
            'overdue': {
              enabled: document.getElementById('notif-overdue').checked,
              priority: 1,
              interval: parseInt(document.getElementById('interval-overdue').value)
            },
            'renewal': {
              enabled: document.getElementById('notif-renewal').checked,
              priority: 4,
              interval: parseInt(document.getElementById('interval-renewal').value)
            }
          }
        };

        const jwt = localStorage.getItem('jwt');
        const response = await fetch(`${ADMIN_BASE_URL}/admin/automation/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ config })
        });

        if (!response.ok) throw new Error('Error al guardar configuraciÃ³n');

        await loadAutomationConfig();
        showTemporaryNotification('ğŸ’¾ ConfiguraciÃ³n guardada correctamente', 'success');
      } catch (err) {
        console.error('Error saving automation config:', err);
        showTemporaryNotification('âŒ Error al guardar: ' + err.message, 'error');
      }
    }

    // Reset to default values
    async function resetAutomationConfig() {
      if (!confirm('Â¿Restaurar valores por defecto? Esto sobrescribirÃ¡ la configuraciÃ³n actual.')) {
        return;
      }

      document.getElementById('interval-bulk').value = 3000;
      document.getElementById('interval-retry').value = 5000;
      document.getElementById('interval-check').value = 60000;
      updateIntervalDisplay('bulk', 3000);
      updateIntervalDisplay('retry', 5000);
      updateIntervalDisplay('check', 60000);

      document.getElementById('notif-3-days').checked = true;
      document.getElementById('interval-3-days').value = 2000;
      document.getElementById('notif-2-days').checked = true;
      document.getElementById('interval-2-days').value = 2000;
      document.getElementById('notif-1-day').checked = true;
      document.getElementById('interval-1-day').value = 2000;
      document.getElementById('notif-due-today').checked = true;
      document.getElementById('interval-due-today').value = 1000;
      document.getElementById('notif-overdue').checked = true;
      document.getElementById('interval-overdue').value = 1000;
      document.getElementById('notif-renewal').checked = true;
      document.getElementById('interval-renewal').value = 3000;

      document.getElementById('limit-per-hour').value = 50;
      document.getElementById('limit-retries').value = 3;
      document.getElementById('limit-cooldown').value = 30;

      showTemporaryNotification('â†º Valores restaurados a configuraciÃ³n por defecto', 'info');
    }

    // Show temporary notification
    function showTemporaryNotification(message, type = 'info') {
      const alertSection = document.getElementById('alerts-section');
      const alertId = 'temp-alert-' + Date.now();
      
      let bgColor = 'bg-blue-500/10 border-blue-500/30';
      if (type === 'success') bgColor = 'bg-green-500/10 border-green-500/30';
      if (type === 'error') bgColor = 'bg-red-500/10 border-red-500/30';
      if (type === 'warning') bgColor = 'bg-orange-500/10 border-orange-500/30';
      
      const alert = document.createElement('div');
      alert.id = alertId;
      alert.className = `glass p-4 rounded-xl border ${bgColor}`;
      alert.innerHTML = `<p class="text-sm">${message}</p>`;
      
      alertSection.appendChild(alert);
      
      setTimeout(() => {
        const el = document.getElementById(alertId);
        if (el) el.remove();
      }, 5000);
    }

    // Check if user is admin and show automation panel
    async function checkAdminAndShowAutomationPanel() {
      try {
        const jwt = localStorage.getItem('jwt');
        if (!jwt) {
          console.log('No JWT found, skipping admin check');
          return;
        }

        // Verificar con el servidor backend si el usuario es admin
        const response = await fetch(`${ADMIN_BASE_URL}/admin/verify`, {
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          console.log('Not an admin user');
          return;
        }

        const result = await response.json();
        
        if (result.isAdmin) {
          console.log('âœ… User is admin, showing automation panel');
          document.getElementById('automation-config-panel').classList.remove('hidden');
          await loadAutomationConfig();
          
          // Actualizar estadÃ­sticas cada minuto
          setInterval(loadTodayStats, 60000);
        } else {
          console.log('User is not admin');
        }
      } catch (err) {
        console.error('Error checking admin status:', err);
      }
    }

    // Initialize automation panel on page load
    window.addEventListener('load', () => {
      setTimeout(checkAdminAndShowAutomationPanel, 1000);
    });

  </script>

    <!-- Modal detalle ingresos 30d -->
    <div id="revenue30-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
      <div class="glass p-6 rounded-2xl max-w-4xl w-full mx-4">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold">ğŸ“Š Detalle: Ingresos Ãšltimos 30 DÃ­as</h3>
            <p class="text-xs muted mt-1">Cuentas que generaron ingresos en el perÃ­odo</p>
          </div>
          <button onclick="closeRevenue30Modal()" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-all">âœ• Cerrar</button>
        </div>
        <div class="mb-4 p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
          <div class="text-sm muted">Total del PerÃ­odo</div>
          <div id="revenue30-sum" class="text-3xl font-bold text-green-400">$0.00</div>
        </div>
        <div style="max-height:400px; overflow:auto;" class="custom-scrollbar">
          <table class="w-full text-sm table-auto">
            <thead class="muted text-xs text-left sticky top-0 glass">
              <tr>
                <th class="p-3">Fecha de Compra</th>
                <th class="p-3">Propietario</th>
                <th class="p-3 text-right">Precio</th>
              </tr>
            </thead>
            <tbody id="revenue30-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
</body>
<script src="assets/ui.js"></script>
</html>